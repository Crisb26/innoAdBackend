package com.innoad.modules.graficos.controlador;\n\nimport com.innoad.modules.stats.servicio.ServicioAnalytics;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.http.HttpStatus;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.*;\nimport java.util.HashMap;\nimport java.util.Map;\nimport java.util.ArrayList;\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/graficos\")\n@Slf4j\n@CrossOrigin(origins = \"*\", maxAge = 3600)\npublic class ControladorGraficos {\n\n    @Autowired\n    private ServicioAnalytics servicioAnalytics;\n\n    @GetMapping(\"/{periodo}\")\n    @PreAuthorize(\"hasAnyRole('ADMIN', 'SUPER_ADMIN', 'OPERATOR')\")\n    public ResponseEntity<Map<String, Object>> obtenerGraficos(@PathVariable String periodo) {\n        try {\n            log.info(\"Solicitud de graficos para periodo: {}\", periodo);\n            \n            Map<String, Object> respuesta = new HashMap<>();\n            \n            List<String> labels = new ArrayList<>();\n            List<Integer> datosChat = new ArrayList<>();\n            List<Integer> datosIA = new ArrayList<>();\n            \n            switch (periodo.toLowerCase()) {\n                case \"ultima-hora\":\n                    generarDatosUltimaHora(labels, datosChat, datosIA);\n                    break;\n                case \"hoy\":\n                    generarDatosHoy(labels, datosChat, datosIA);\n                    break;\n                case \"semanal\":\n                    generarDatosSemanal(labels, datosChat, datosIA);\n                    break;\n                default:\n                    generarDatosHoy(labels, datosChat, datosIA);\n            }\n            \n            respuesta.put(\"labels\", labels);\n            respuesta.put(\"datasets\", crearDatasets(datosChat, datosIA));\n            respuesta.put(\"periodo\", periodo);\n            \n            return ResponseEntity.ok(respuesta);\n        } catch (Exception e) {\n            log.error(\"Error obteniendo graficos\", e);\n            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();\n        }\n    }\n\n    private void generarDatosUltimaHora(List<String> labels, List<Integer> datosChat, List<Integer> datosIA) {\n        for (int i = 0; i < 12; i++) {\n            labels.add(String.format(\"%02d:%02d\", i * 5 / 60, i * 5 % 60));\n            datosChat.add((int) (Math.random() * 100));\n            datosIA.add((int) (Math.random() * 30));\n        }\n    }\n\n    private void generarDatosHoy(List<String> labels, List<Integer> datosChat, List<Integer> datosIA) {\n        String[] horas = {\"00:00\", \"04:00\", \"08:00\", \"12:00\", \"16:00\", \"20:00\"};\n        for (String hora : horas) {\n            labels.add(hora);\n            datosChat.add((int) (Math.random() * 500));\n            datosIA.add((int) (Math.random() * 150));\n        }\n    }\n\n    private void generarDatosSemanal(List<String> labels, List<Integer> datosChat, List<Integer> datosIA) {\n        String[] dias = {\"Lun\", \"Mar\", \"Mie\", \"Jue\", \"Vie\", \"Sab\", \"Dom\"};\n        for (String dia : dias) {\n            labels.add(dia);\n            datosChat.add((int) (Math.random() * 3000));\n            datosIA.add((int) (Math.random() * 1000));\n        }\n    }\n\n    private List<Map<String, Object>> crearDatasets(List<Integer> datosChat, List<Integer> datosIA) {\n        List<Map<String, Object>> datasets = new ArrayList<>();\n        \n        Map<String, Object> datasetChat = new HashMap<>();\n        datasetChat.put(\"label\", \"Mensajes Chat\");\n        datasetChat.put(\"data\", datosChat);\n        datasetChat.put(\"borderColor\", \"rgb(102, 126, 234)\");\n        datasetChat.put(\"backgroundColor\", \"rgba(102, 126, 234, 0.1)\");\n        datasetChat.put(\"tension\", 0.4);\n        datasetChat.put(\"fill\", true);\n        datasets.add(datasetChat);\n        \n        Map<String, Object> datasetIA = new HashMap<>();\n        datasetIA.put(\"label\", \"Preguntas IA\");\n        datasetIA.put(\"data\", datosIA);\n        datasetIA.put(\"borderColor\", \"rgb(245, 87, 108)\");\n        datasetIA.put(\"backgroundColor\", \"rgba(245, 87, 108, 0.1)\");\n        datasetIA.put(\"tension\", 0.4);\n        datasetIA.put(\"fill\", true);\n        datasets.add(datasetIA);\n        \n        return datasets;\n    }\n}\n