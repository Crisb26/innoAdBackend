package com.innoad.modules.reportes.controlador;\n\nimport com.innoad.modules.reportes.dto.ReporteDTO;\nimport com.innoad.modules.reportes.servicio.ServicioReportes;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.HttpStatus;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.*;\n\n@RestController\n@RequestMapping(\"/api/reportes\")\n@Slf4j\n@CrossOrigin(origins = \"*\", maxAge = 3600)\npublic class ControladorReportes {\n\n    @Autowired\n    private ServicioReportes servicioReportes;\n\n    @PostMapping(\"/generar\")\n    @PreAuthorize(\"hasAnyRole('ADMIN', 'SUPER_ADMIN', 'OPERATOR')\")\n    public ResponseEntity<ReporteDTO> generarReporte(\n            @RequestParam String tipo,\n            @RequestParam String periodo) {\n        try {\n            log.info(\"Solicitud para generar reporte: tipo={}, periodo={}\", tipo, periodo);\n            ReporteDTO reporte = servicioReportes.generarReporteAnalytics(tipo, periodo);\n            return ResponseEntity.ok(reporte);\n        } catch (Exception e) {\n            log.error(\"Error generando reporte\", e);\n            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();\n        }\n    }\n\n    @GetMapping(\"/descargar/{id}\")\n    @PreAuthorize(\"hasAnyRole('ADMIN', 'SUPER_ADMIN', 'OPERATOR')\")\n    public ResponseEntity<byte[]> descargarReporte(@PathVariable String id) {\n        try {\n            log.info(\"Solicitud para descargar reporte: {}\", id);\n            byte[] contenido = servicioReportes.exportarPDF(id);\n            \n            HttpHeaders headers = new HttpHeaders();\n            headers.setContentType(MediaType.APPLICATION_PDF);\n            headers.setContentDispositionFormData(\"attachment\", \"reporte_\" + id + \".pdf\");\n            headers.setContentLength(contenido.length);\n            \n            return ResponseEntity.ok().headers(headers).body(contenido);\n        } catch (Exception e) {\n            log.error(\"Error descargando reporte\", e);\n            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();\n        }\n    }\n\n    @GetMapping(\"/descargar-csv/{id}\")\n    @PreAuthorize(\"hasAnyRole('ADMIN', 'SUPER_ADMIN', 'OPERATOR')\")\n    public ResponseEntity<byte[]> descargarReporteCSV(@PathVariable String id) {\n        try {\n            log.info(\"Solicitud para descargar reporte CSV: {}\", id);\n            byte[] contenido = servicioReportes.exportarCSV(id);\n            \n            HttpHeaders headers = new HttpHeaders();\n            headers.setContentType(MediaType.parseMediaType(\"text/csv\"));\n            headers.setContentDispositionFormData(\"attachment\", \"reporte_\" + id + \".csv\");\n            headers.setContentLength(contenido.length);\n            \n            return ResponseEntity.ok().headers(headers).body(contenido);\n        } catch (Exception e) {\n            log.error(\"Error descargando reporte CSV\", e);\n            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();\n        }\n    }\n\n    @GetMapping(\"/pdf/{periodo}\")\n    @PreAuthorize(\"hasAnyRole('ADMIN', 'SUPER_ADMIN', 'OPERATOR')\")\n    public ResponseEntity<byte[]> exportarPDF(@PathVariable String periodo) {\n        try {\n            log.info(\"Exportando PDF para periodo: {}\", periodo);\n            byte[] contenido = servicioReportes.exportarPDF(periodo);\n            \n            HttpHeaders headers = new HttpHeaders();\n            headers.setContentType(MediaType.APPLICATION_PDF);\n            headers.setContentDispositionFormData(\"attachment\", \"reporte_\" + periodo + \".pdf\");\n            \n            return ResponseEntity.ok().headers(headers).body(contenido);\n        } catch (Exception e) {\n            log.error(\"Error en exportacion PDF\", e);\n            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();\n        }\n    }\n\n    @GetMapping(\"/csv/{periodo}\")\n    @PreAuthorize(\"hasAnyRole('ADMIN', 'SUPER_ADMIN', 'OPERATOR')\")\n    public ResponseEntity<byte[]> exportarCSV(@PathVariable String periodo) {\n        try {\n            log.info(\"Exportando CSV para periodo: {}\", periodo);\n            byte[] contenido = servicioReportes.exportarCSV(periodo);\n            \n            HttpHeaders headers = new HttpHeaders();\n            headers.setContentType(MediaType.parseMediaType(\"text/csv\"));\n            headers.setContentDispositionFormData(\"attachment\", \"reporte_\" + periodo + \".csv\");\n            \n            return ResponseEntity.ok().headers(headers).body(contenido);\n        } catch (Exception e) {\n            log.error(\"Error en exportacion CSV\", e);\n            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();\n        }\n    }\n}\n